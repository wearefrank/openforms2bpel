<Module xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../FrankConfig.xsd">
    <Adapter
        name="UpdateInitiatorSubjectCommandHandler"
        active="${UpdateInitiatorSubjectCommandHandler.Active}"
        description=""
        >

        <Receiver
            name="UpdateInitiatorSubjectCommandHandler"
            transactionAttribute="Required"
            pollInterval="1"
            maxRetries="1"
            >
            <MessageStoreListener
                name="UpdateInitiatorSubjectCommandHandler"
				slotId="${instance.name}/UpdateInitiatorSubjectCommand"
                sessionKeys="CaseReferenceNumber" 
				/>
        </Receiver>

        <Pipeline>
            <Exits>
                <Exit name="EXIT" state="SUCCESS" />
                <Exit name="EXCEPTION" state="ERROR" />
            </Exits>

            <XsltPipe
                name="CreateLookUpCaseIdsRequestMessage"
                getInputFromFixedValue="&lt;dummy/&gt;"
                styleSheetName="Bpel/Cases/Model/LookUpCaseIdsRequestMessage.xslt"
                storeResultInSessionKey="LookUpCaseIdsRequestMessage"
                >
                <Param name="ReferenceNumber" sessionKey="CaseReferenceNumber" />
                <Forward name="success" path="BpelCasesPostLookUpCaseIdsSender" />
            </XsltPipe>

            <SenderPipe
                name="BpelCasesPostLookUpCaseIdsSender"
                storeResultInSessionKey="LookUpCaseIdsResponseMessage"
                >
                <IbisLocalSender
                    name="BpelCasesPostLookUpCaseIdsLocalSender"
                    javaListener="Bpel_Cases_Post"
                    >
                </IbisLocalSender>
                <Param name="soapAction" value="cases:lookUpCaseIds" />
                <Forward name="success" path="CreateReadCasesRequestMessage" />
            </SenderPipe>

            <XsltPipe
                name="CreateReadCasesRequestMessage"
                getInputFromFixedValue="&lt;dummy/&gt;"
                styleSheetName="Bpel/Cases/Model/ReadCasesRequestMessage.xslt"
                storeResultInSessionKey="ReadCasesRequestMessage"
                >
                <Param name="Id" sessionKey="LookUpCaseIdsResponseMessage" xpathExpression="//*:cases/*:case/*:id" />
                <Forward name="success" path="BpelCasesPostReadCasesSender" />
            </XsltPipe>

            <SenderPipe
                name="BpelCasesPostReadCasesSender"
                storeResultInSessionKey="ReadCasesResponseMessage"
                >
                <IbisLocalSender
                    name="BpelCasesPostReadCasesLocalSender"
                    javaListener="Bpel_Cases_Post"
                    >
                </IbisLocalSender>
                <Param name="soapAction" value="cases:readCases" />
                <Forward name="success" path="CheckInitiatorSubjectIsPerson" />
            </SenderPipe>

            <XmlIfPipe
                name="CheckInitiatorSubjectIsPerson"
                xpathExpression="string-length(//*:caseDetailsMessage/*:cases/*:case/*:initiatingSubject/*:person) gt 0"
                >
                <Forward name="then" path="CreateUpdatePersonsMessage" />
                <Forward name="else" path="CheckInitiatorSubjectIsOrganization" />
            </XmlIfPipe>

            <XsltPipe
                name="CreateUpdatePersonsMessage"
                getInputFromSessionKey="ReadCasesResponseMessage"
                styleSheetName="Bpel/Cases/Model/UpdatePersonsRequestMessage.xslt"
                storeResultInSessionKey="UpdatePersonsRequestMessage"
                >
                <Param name="EmailAddress" sessionKey="originalMessage" xpathExpression="//*[starts-with(name(), 'contactgegevens')]/*[starts-with(name(), 'eMailadres')]" />
                <Param name="TelephoneNumber" sessionKey="originalMessage" xpathExpression="//*[starts-with(name(), 'contactgegevens')]/*[starts-with(name(), 'telefoonnummer')]" />
                <Forward name="success" path="BpelCasesPostUpdatePersonsSender" />
            </XsltPipe>

            <SenderPipe
                name="BpelCasesPostUpdatePersonsSender"
                storeResultInSessionKey="UpdatePersonsResponseMessage"
                >
                <IbisLocalSender
                    name="BpelCasesPostUpdatePersonsLocalSender"
                    javaListener="Bpel_Cases_Post"
                    >
                </IbisLocalSender>
                <Param name="soapAction" value="cases:updatePersons" />
                <Forward name="success" path="EXIT" />
            </SenderPipe>

            <XmlIfPipe
                name="CheckInitiatorSubjectIsOrganization"
                xpathExpression="string-length(//*:caseDetailsMessage/*:cases/*:case/*:initiatingSubject/*:organization) gt 0"
                >
                <Forward name="then" path="CreateUpdateOrganizationsMessage" />
                <Forward name="else" path="EXIT" />
            </XmlIfPipe>

            <XsltPipe
                name="CreateUpdateOrganizationsMessage"
                getInputFromSessionKey="ReadCasesResponseMessage"
                styleSheetName="Bpel/Cases/Model/UpdateOrganizationsRequestMessage.xslt"
                storeResultInSessionKey="UpdateOrganizationsRequestMessage"
                >
                <Param name="EmailAddress" sessionKey="originalMessage" xpathExpression="//*[starts-with(name(), 'contactgegevens')]/*[starts-with(name(), 'eMailadres')]" />
                <Param name="TelephoneNumber" sessionKey="originalMessage" xpathExpression="//*[starts-with(name(), 'contactgegevens')]/*[starts-with(name(), 'telefoonnummer')]" />
                <Forward name="success" path="BpelCasesPostUpdateOrganizationsSender" />
            </XsltPipe>

            <SenderPipe
                name="BpelCasesPostUpdateOrganizationsSender"
                storeResultInSessionKey="UpdateOrganizationsResponseMessage"
                >
                <IbisLocalSender
                    name="BpelCasesPostUpdateOrganizationsLocalSender"
                    javaListener="Bpel_Cases_Post"
                    >
                </IbisLocalSender>
                <Param name="soapAction" value="cases:updateOrganizations" />
                <Forward name="success" path="EXIT" />
            </SenderPipe>

            <!-- <SenderPipe
				name="InitiatorSubjectUpdatedEventSender"
                getInputFromSessionKey="CaseReferenceNumber"
                transactionAttribute="Required"
				>
				<MessageStoreSender
					name="InitiatorSubjectUpdatedEventMessageStoreSender"
					slotId="${instance.name}/InitiatorSubjectUpdatedEventEvent"
                    onlyStoreWhenMessageIdUnique="true"
					>
				</MessageStoreSender>
                <Forward name="success" path="EXIT" />
			</SenderPipe> -->
        </Pipeline>
    </Adapter>
</Module>